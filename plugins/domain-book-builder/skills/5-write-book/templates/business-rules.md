# business-rules.md 템플릿

## 비즈니스 규칙 구조

### 기본 템플릿

```markdown
# {Domain} 비즈니스 규칙

## 📐 제약 조건

### 1. {제약 이름}
{설명}

**이유**: {왜 이 제약이 필요한가}

---

## 🔄 상태 전이

{있으면 FSM 다이어그램, 없으면 "이 도메인은 상태 전이가 없습니다"}

---

## 🔐 권한 규칙

| 액션 | 권한 | 조건 |
|------|------|------|
| ... | ... | ... |

---

## 💡 비즈니스 로직

### {로직 이름}

\`\`\`
{처리 흐름}
\`\`\`

---

## 🚨 예외 상황 처리

### 1. {예외 상황}
- **대응**: {처리 방법}
```

---

## 제약 조건 (Constraints)

### 템플릿

```markdown
### {번호}. {제약 이름}
{제약 내용을 서술형으로}

**이유**: {왜 이 제약이 필요한지 설명}
```

### 출처

domain-model.md의 "제약 조건" 섹션 기반:
- 필수/선택 규칙
- 유일성 제약
- 형식 검증
- 값 범위 제한
- 기본값 규칙

### 예시 (users 도메인)

```markdown
## 📐 제약 조건

### 1. 이메일 유일성
이메일 주소는 시스템 전체에서 고유해야 한다.

**이유**: 이메일을 사용자 식별 수단으로 사용하므로, 중복되면 로그인 시 혼란 발생

---

### 2. 닉네임 길이
닉네임은 최소 1자, 최대 50자여야 한다.

**이유**: 너무 짧으면 식별 불가, 너무 길면 UI 깨짐

---

### 3. 선호 언어 제한
선호 언어는 '한국어' 또는 '영어'만 가능하다.

**이유**: MVP에서는 2개 언어만 지원

---

### 4. 프로필 사진 선택성
프로필 사진은 선택 사항이다.

**이유**: 가입 장벽을 낮추기 위해 필수가 아님
```

---

## 상태 전이 (State Machine)

### 상태 전이가 없는 경우

```markdown
## 🔄 상태 전이

이 도메인은 상태 전이가 없습니다.

사용자는 "활성" 상태만 가지며, 탈퇴 시 즉시 삭제됩니다.
```

**예시 (users, phrases 도메인)**

---

### 상태 전이가 있는 경우

**템플릿**:
```markdown
## 🔄 상태 전이

### 상태 목록

| 상태 | 설명 |
|------|------|
| {STATE_1} | {상태 설명} |
| {STATE_2} | {상태 설명} |

### 전이 규칙

\`\`\`
{STATE_1} → {STATE_2}: {전이 조건}
{STATE_2} → {STATE_3}: {전이 조건}
\`\`\`

### 전이 다이어그램

\`\`\`
{STATE_1}
    ↓ {액션}
{STATE_2}
    ↓ {액션}
{STATE_3}
\`\`\`
```

**예시 (missions 도메인)**:
```markdown
## 🔄 상태 전이

### 상태 목록

| 상태 | 설명 |
|------|------|
| NOT_STARTED | 미션을 아직 시작하지 않음 |
| IN_PROGRESS | 미션 진행 중 |
| COMPLETED | 미션 완료 |

### 전이 규칙

\`\`\`
NOT_STARTED → IN_PROGRESS: 사용자가 "시작하기" 클릭
IN_PROGRESS → COMPLETED: 필요한 번역 개수 달성
\`\`\`

### 전이 다이어그램

\`\`\`
NOT_STARTED
    ↓ 미션 시작
IN_PROGRESS
    ↓ 목표 달성
COMPLETED
\`\`\`

**금지 전이**:
- COMPLETED → IN_PROGRESS (완료된 미션은 재진행 불가)
- NOT_STARTED → COMPLETED (시작하지 않고 완료 불가)
```

---

## 권한 규칙 (Permission Rules)

### 템플릿

```markdown
## 🔐 권한 규칙

| 액션 | 권한 | 조건 |
|------|------|------|
| {액션 이름} | {누가 할 수 있는가} | {추가 조건} |
```

### 출처

- domain-model.md의 생명주기 "권한 검사"
- api-spec.md의 403 오류 조건
- SESSION.md의 권한 관련 결정

### 예시 (users 도메인)

```markdown
## 🔐 권한 규칙

| 액션 | 권한 | 조건 |
|------|------|------|
| 회원가입 | 누구나 | - |
| 프로필 조회 | 본인 | 자신의 프로필만 |
| 프로필 수정 | 본인 | 자신의 프로필만 |
| 회원 탈퇴 | 본인 | 자신의 계정만 |
```

### 예시 (translations 도메인)

```markdown
## 🔐 권한 규칙

| 액션 | 권한 | 조건 |
|------|------|------|
| 번역 요청 | 로그인한 사용자 | - |
| 번역 기록 조회 | 본인 | 자신의 기록만 |
| 번역 기록 삭제 | 본인 | 자신의 기록만 |
```

---

## 비즈니스 로직 (Business Logic)

### 템플릿

```markdown
## 💡 비즈니스 로직

### {로직 이름}

\`\`\`
{단계별 처리 흐름}
\`\`\`
```

### 출처

- domain-model.md의 생명주기
- api-spec.md의 수도코드 (복잡한 API만)
- SESSION.md의 비즈니스 룰 결정

### 예시 1: 기본값 설정

```markdown
## 💡 비즈니스 로직

### 선호 언어 기본값

\`\`\`
회원가입 시:
  - 선호 언어가 제공되면: 해당 언어 사용
  - 제공되지 않으면: 기본값 '영어' 설정
\`\`\`
```

### 예시 2: Cascade 삭제

```markdown
### Cascade 삭제

\`\`\`
회원 탈퇴 시:
  1. 사용자의 모든 번역 기록 삭제
  2. 사용자의 모든 미션 진행 기록 삭제
  3. 사용자 엔티티 삭제
\`\`\`
```

### 예시 3: 진행률 계산

```markdown
### 미션 진행률 계산

\`\`\`
진행률 = (완료한 번역 개수 / 필요한 번역 개수) × 100

예시:
  - 필요한 번역: 10개
  - 완료한 번역: 6개
  - 진행률: (6 / 10) × 100 = 60.0%

상태 결정:
  - 진행률 = 0%: NOT_STARTED
  - 0% < 진행률 < 100%: IN_PROGRESS
  - 진행률 = 100%: COMPLETED
\`\`\`
```

---

## 예외 상황 처리 (Exception Handling)

### 템플릿

```markdown
## 🚨 예외 상황 처리

### {번호}. {예외 상황}
- **대응**: {어떻게 처리하는가}
- **메시지**: {사용자에게 보여줄 메시지} (선택)
```

### 출처

api-spec.md의 오류 응답 기반:
- 400 오류 → 검증 실패
- 403 오류 → 권한 부족
- 404 오류 → 리소스 없음
- 409 오류 → 충돌 (중복 등)

### 예시 (users 도메인)

```markdown
## 🚨 예외 상황 처리

### 1. 이메일 중복
- **대응**: 가입 차단 + "이미 가입된 이메일입니다" 메시지

### 2. 존재하지 않는 사용자 조회
- **대응**: 404 오류 + "존재하지 않는 사용자입니다" 메시지

### 3. 권한 없는 수정 시도
- **대응**: 403 오류 + "본인만 수정할 수 있습니다" 메시지

### 4. 잘못된 이메일 형식
- **대응**: 검증 실패 + "이메일 형식이 올바르지 않습니다" 메시지

### 5. 필수 필드 누락
- **대응**: 검증 실패 + "필수 필드가 누락되었습니다" 메시지

### 6. 지원하지 않는 언어 코드
- **대응**: 검증 실패 + "지원하지 않는 언어입니다" 메시지
```

---

## 완전한 예시

### users 도메인

```markdown
# users 비즈니스 규칙

## 📐 제약 조건

### 1. 이메일 유일성
이메일 주소는 시스템 전체에서 고유해야 한다.

**이유**: 이메일을 사용자 식별 수단으로 사용하므로, 중복되면 로그인 시 혼란 발생

---

### 2. 닉네임 길이
닉네임은 최소 1자, 최대 50자여야 한다.

**이유**: 너무 짧으면 식별 불가, 너무 길면 UI 깨짐

---

### 3. 선호 언어 제한
선호 언어는 '한국어' 또는 '영어'만 가능하다.

**이유**: MVP에서는 2개 언어만 지원

---

### 4. 프로필 사진 선택성
프로필 사진은 선택 사항이다.

**이유**: 가입 장벽을 낮추기 위해 필수가 아님

---

## 🔄 상태 전이

이 도메인은 상태 전이가 없습니다.

사용자는 "활성" 상태만 가지며, 탈퇴 시 즉시 삭제됩니다.

---

## 🔐 권한 규칙

| 액션 | 권한 | 조건 |
|------|------|------|
| 회원가입 | 누구나 | - |
| 프로필 조회 | 본인 | 자신의 프로필만 |
| 프로필 수정 | 본인 | 자신의 프로필만 |
| 회원 탈퇴 | 본인 | 자신의 계정만 |

---

## 💡 비즈니스 로직

### 선호 언어 기본값

\`\`\`
회원가입 시:
  - 선호 언어가 제공되면: 해당 언어 사용
  - 제공되지 않으면: 기본값 '영어' 설정
\`\`\`

---

### Cascade 삭제

\`\`\`
회원 탈퇴 시:
  1. 사용자의 모든 번역 기록 삭제
  2. 사용자의 모든 미션 진행 기록 삭제
  3. 사용자 엔티티 삭제
\`\`\`

---

## 🚨 예외 상황 처리

### 1. 이메일 중복
- **대응**: 가입 차단 + "이미 가입된 이메일입니다" 메시지

### 2. 존재하지 않는 사용자 조회
- **대응**: 404 오류 + "존재하지 않는 사용자입니다" 메시지

### 3. 권한 없는 수정 시도
- **대응**: 403 오류 + "본인만 수정할 수 있습니다" 메시지

### 4. 잘못된 이메일 형식
- **대응**: 검증 실패 + "이메일 형식이 올바르지 않습니다" 메시지

### 5. 필수 필드 누락
- **대응**: 검증 실패 + "필수 필드가 누락되었습니다" 메시지

### 6. 지원하지 않는 언어 코드
- **대응**: 검증 실패 + "지원하지 않는 언어입니다" 메시지
```

---

### missions 도메인 (상태 전이 있음)

```markdown
# missions 비즈니스 규칙

## 📐 제약 조건

### 1. 미션 중복 방지
한 사용자는 동일한 미션을 동시에 여러 개 진행할 수 없다.

**이유**: 진행 상태 추적이 복잡해지고, 사용자 경험이 혼란스러워짐

---

### 2. 필요한 번역 개수
미션마다 완료에 필요한 번역 개수가 정해져 있다.

**이유**: 학습 목표 달성을 위한 최소 요구사항

---

## 🔄 상태 전이

### 상태 목록

| 상태 | 설명 |
|------|------|
| NOT_STARTED | 미션을 아직 시작하지 않음 |
| IN_PROGRESS | 미션 진행 중 |
| COMPLETED | 미션 완료 |

### 전이 규칙

\`\`\`
NOT_STARTED → IN_PROGRESS: 사용자가 "시작하기" 클릭
IN_PROGRESS → COMPLETED: 필요한 번역 개수 달성
\`\`\`

### 전이 다이어그램

\`\`\`
NOT_STARTED
    ↓ 미션 시작
IN_PROGRESS
    ↓ 목표 달성
COMPLETED
\`\`\`

**금지 전이**:
- COMPLETED → IN_PROGRESS (완료된 미션은 재진행 불가)
- NOT_STARTED → COMPLETED (시작하지 않고 완료 불가)

---

## 🔐 권한 규칙

| 액션 | 권한 | 조건 |
|------|------|------|
| 미션 시작 | 로그인한 사용자 | 동일 미션 진행 중이 아님 |
| 진행 상황 조회 | 본인 | 자신의 미션만 |
| 미션 완료 | 시스템 자동 | 목표 달성 시 |

---

## 💡 비즈니스 로직

### 미션 진행률 계산

\`\`\`
진행률 = (완료한 번역 개수 / 필요한 번역 개수) × 100

예시:
  - 필요한 번역: 10개
  - 완료한 번역: 6개
  - 진행률: (6 / 10) × 100 = 60.0%

상태 결정:
  - 진행률 = 0%: NOT_STARTED
  - 0% < 진행률 < 100%: IN_PROGRESS
  - 진행률 = 100%: COMPLETED
\`\`\`

---

### 자동 완료 처리

\`\`\`
번역 생성 시:
  1. 해당 사용자의 모든 진행 중인 미션 조회
  2. 각 미션의 진행률 재계산
  3. 진행률이 100%가 된 미션이 있으면:
     - 상태를 COMPLETED로 변경
     - 완료 시각 기록
\`\`\`

---

## 🚨 예외 상황 처리

### 1. 이미 진행 중인 미션 재시작
- **대응**: 400 오류 + "이미 진행 중인 미션입니다" 메시지

### 2. 존재하지 않는 미션
- **대응**: 404 오류 + "존재하지 않는 미션입니다" 메시지

### 3. 완료된 미션 재시작
- **대응**: 400 오류 + "이미 완료한 미션입니다" 메시지
```

---

## 검증 체크리스트

business-rules.md 작성 완료 후:

- [ ] 제약 조건이 domain-model.md와 일치
- [ ] 각 제약에 이유 설명 포함
- [ ] 상태 전이가 정확함 (있는 경우)
- [ ] 권한 규칙이 api-spec.md 403 오류와 일치
- [ ] 비즈니스 로직이 구체적으로 작성됨
- [ ] 예외 상황이 api-spec.md 오류 응답과 일치
- [ ] 한글 메시지 사용
- [ ] 기술 용어 사용 안 함
