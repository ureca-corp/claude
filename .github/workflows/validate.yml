name: Validate Plugins

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  validate-marketplace:
    name: Validate Marketplace Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate JSON syntax
        run: |
          echo "Validating marketplace.json..."
          if ! jq empty .claude-plugin/marketplace.json 2>/dev/null; then
            echo "❌ Invalid JSON in marketplace.json"
            exit 1
          fi
          echo "✅ marketplace.json is valid JSON"

      - name: Check required files
        run: |
          echo "Checking required marketplace files..."
          REQUIRED_FILES=(
            ".claude-plugin/marketplace.json"
            "README.md"
            "LICENSE"
            "CLAUDE.md"
            "CONTRIBUTING.md"
            "CHANGELOG.md"
          )

          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              MISSING_FILES+=("$file")
            fi
          done

          if [ ${#MISSING_FILES[@]} -gt 0 ]; then
            echo "❌ Missing required files:"
            printf '%s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          echo "✅ All required marketplace files present"

      - name: Validate marketplace metadata
        run: |
          echo "Validating marketplace metadata..."

          # Check required fields
          if ! jq -e '.name' .claude-plugin/marketplace.json >/dev/null; then
            echo "❌ Missing 'name' field"
            exit 1
          fi

          if ! jq -e '.repository' .claude-plugin/marketplace.json >/dev/null; then
            echo "❌ Missing 'repository' field"
            exit 1
          fi

          if ! jq -e '.plugins' .claude-plugin/marketplace.json >/dev/null; then
            echo "❌ Missing 'plugins' array"
            exit 1
          fi

          echo "✅ Marketplace metadata is valid"

  validate-plugins:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    strategy:
      matrix:
        plugin:
          - domain-book-builder

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate plugin.json
        run: |
          PLUGIN_JSON="plugins/${{ matrix.plugin }}/.claude-plugin/plugin.json"
          echo "Validating $PLUGIN_JSON..."

          if [ ! -f "$PLUGIN_JSON" ]; then
            echo "❌ plugin.json not found"
            exit 1
          fi

          if ! jq empty "$PLUGIN_JSON" 2>/dev/null; then
            echo "❌ Invalid JSON in plugin.json"
            exit 1
          fi

          # Check required fields
          if ! jq -e '.name' "$PLUGIN_JSON" >/dev/null; then
            echo "❌ Missing 'name' field"
            exit 1
          fi

          if ! jq -e '.version' "$PLUGIN_JSON" >/dev/null; then
            echo "❌ Missing 'version' field"
            exit 1
          fi

          if ! jq -e '.description' "$PLUGIN_JSON" >/dev/null; then
            echo "❌ Missing 'description' field"
            exit 1
          fi

          echo "✅ plugin.json is valid"

      - name: Check plugin structure
        run: |
          PLUGIN_DIR="plugins/${{ matrix.plugin }}"
          echo "Checking plugin structure..."

          REQUIRED_DIRS=()
          REQUIRED_FILES=(
            "$PLUGIN_DIR/.claude-plugin/plugin.json"
            "$PLUGIN_DIR/README.md"
          )

          # Check if at least one component directory exists
          COMPONENT_DIRS=(
            "$PLUGIN_DIR/skills"
            "$PLUGIN_DIR/commands"
            "$PLUGIN_DIR/agents"
            "$PLUGIN_DIR/hooks"
          )

          HAS_COMPONENT=false
          for dir in "${COMPONENT_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              HAS_COMPONENT=true
              break
            fi
          done

          if [ "$HAS_COMPONENT" = false ]; then
            echo "❌ No component directories (skills/commands/agents/hooks) found"
            exit 1
          fi

          # Check required files
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              exit 1
            fi
          done

          echo "✅ Plugin structure is valid"

      - name: Validate skills
        run: |
          SKILLS_DIR="plugins/${{ matrix.plugin }}/skills"
          if [ -d "$SKILLS_DIR" ]; then
            echo "Validating skills..."

            # Find all SKILL.md files
            SKILL_FILES=$(find "$SKILLS_DIR" -name "SKILL.md")

            if [ -z "$SKILL_FILES" ]; then
              echo "⚠️  No SKILL.md files found in skills directory"
            else
              for skill in $SKILL_FILES; do
                echo "Checking $skill..."

                # Check for frontmatter
                if ! grep -q "^---$" "$skill"; then
                  echo "❌ Missing frontmatter in $skill"
                  exit 1
                fi

                # Check for required frontmatter fields
                if ! grep -A 10 "^---$" "$skill" | grep -q "name:"; then
                  echo "❌ Missing 'name' in frontmatter: $skill"
                  exit 1
                fi

                if ! grep -A 10 "^---$" "$skill" | grep -q "description:"; then
                  echo "❌ Missing 'description' in frontmatter: $skill"
                  exit 1
                fi
              done

              echo "✅ All skills are valid"
            fi
          fi

      - name: Validate agents
        run: |
          AGENTS_DIR="plugins/${{ matrix.plugin }}/agents"
          if [ -d "$AGENTS_DIR" ]; then
            echo "Validating agents..."

            # Find all agent markdown files
            AGENT_FILES=$(find "$AGENTS_DIR" -name "*.md")

            if [ -z "$AGENT_FILES" ]; then
              echo "⚠️  No agent files found in agents directory"
            else
              for agent in $AGENT_FILES; do
                echo "Checking $agent..."

                # Check for frontmatter
                if ! grep -q "^---$" "$agent"; then
                  echo "❌ Missing frontmatter in $agent"
                  exit 1
                fi

                # Check for required frontmatter fields (either 'identifier' or 'name')
                FRONTMATTER=$(sed -n '/^---$/,/^---$/p' "$agent")
                if ! echo "$FRONTMATTER" | grep -qE "(identifier:|name:)"; then
                  echo "❌ Missing 'identifier' or 'name' in frontmatter: $agent"
                  exit 1
                fi
              done

              echo "✅ All agents are valid"
            fi
          fi

      - name: Validate commands
        run: |
          COMMANDS_DIR="plugins/${{ matrix.plugin }}/commands"
          if [ -d "$COMMANDS_DIR" ]; then
            echo "Validating commands..."

            # Find all command SKILL.md files
            COMMAND_FILES=$(find "$COMMANDS_DIR" -name "SKILL.md")

            if [ -z "$COMMAND_FILES" ]; then
              echo "⚠️  No SKILL.md files found in commands directory"
            else
              for command in $COMMAND_FILES; do
                echo "Checking $command..."

                # Check for frontmatter
                if ! grep -q "^---$" "$command"; then
                  echo "❌ Missing frontmatter in $command"
                  exit 1
                fi
              done

              echo "✅ All commands are valid"
            fi
          fi

  check-links:
    name: Check Markdown Links
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check internal links
        run: |
          echo "Checking internal markdown links..."

          # Find all markdown files
          MD_FILES=$(find . -name "*.md" -not -path "./node_modules/*" -not -path "./.git/*")

          BROKEN_LINKS=()

          for md_file in $MD_FILES; do
            # Extract markdown links
            LINKS=$(grep -oP '\[.*?\]\(\K[^)]+(?=\))' "$md_file" 2>/dev/null || true)

            for link in $LINKS; do
              # Skip external links
              if [[ $link == http* ]] || [[ $link == mailto:* ]]; then
                continue
              fi

              # Skip anchor links
              if [[ $link == \#* ]]; then
                continue
              fi

              # Skip template links (output files that will be generated)
              if [[ $md_file == */templates/* ]] || [[ $md_file == */agents/* ]]; then
                if [[ $link == ./features.md ]] || \
                   [[ $link == ./domain-model.md ]] || \
                   [[ $link == ./api-spec.md ]] || \
                   [[ $link == ./business-rules.md ]] || \
                   [[ $link == ./README.md ]]; then
                  continue
                fi
              fi

              # Resolve relative path
              DIR=$(dirname "$md_file")
              RESOLVED_PATH="$DIR/$link"

              # Remove ./ prefix if present
              RESOLVED_PATH="${RESOLVED_PATH#./}"

              # Check if file exists
              if [ ! -f "$RESOLVED_PATH" ] && [ ! -d "$RESOLVED_PATH" ]; then
                BROKEN_LINKS+=("$md_file -> $link")
              fi
            done
          done

          if [ ${#BROKEN_LINKS[@]} -gt 0 ]; then
            echo "❌ Broken internal links found:"
            printf '%s\n' "${BROKEN_LINKS[@]}"
            exit 1
          fi

          echo "✅ All internal links are valid"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-marketplace, validate-plugins, check-links]
    if: always()

    steps:
      - name: Check results
        run: |
          if [ "${{ needs.validate-marketplace.result }}" != "success" ] || \
             [ "${{ needs.validate-plugins.result }}" != "success" ] || \
             [ "${{ needs.check-links.result }}" != "success" ]; then
            echo "❌ Validation failed"
            exit 1
          fi

          echo "✅ All validations passed!"
